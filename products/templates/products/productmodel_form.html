<!-- templates/products/productmodel_form.html -->
{% extends 'admin/base_admin.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Modifier{% else %}Ajouter{% endif %} un modèle - Jimquad39{% endblock %}

{% block admin_content %}
<div class="container mx-auto px-4 py-6 max-w-4xl">
    <!-- Breadcrumb -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{% url 'admins:admin-dashboard' %}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-red-600">
                    <i class="fas fa-home mr-2"></i>
                    Tableau de bord
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <a href="{% url 'products:productmodel-list' %}" class="ml-1 text-sm font-medium text-gray-700 hover:text-red-600 md:ml-2">Modèles</a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">
                        {% if form.instance.pk %}Modifier{% else %}Ajouter un{% endif %} modèle
                    </span>
                </div>
            </li>
        </ol>
    </nav>

    <!-- Form Header -->
    <div class="md:flex md:items-center md:justify-between mb-6">
        <div class="flex-1 min-w-0">
            <h1 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                {% if form.instance.pk %}
                    Modifier {{ form.instance.brand.name }} {{ form.instance.name }}
                {% else %}
                    Ajouter un nouveau modèle
                {% endif %}
            </h1>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
            <a href="{% if form.instance.pk %}{% url 'products:productmodel-detail' form.instance.slug %}{% else %}{% url 'products:productmodel-list' %}{% endif %}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                <i class="fas fa-arrow-left mr-2 -ml-1 h-4 w-4"></i>
                Retour
            </a>
        </div>
    </div>

    <!-- Form -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        <form method="post" enctype="multipart/form-data" class="space-y-6" x-data="imageUpload">
            {% csrf_token %}
            
            <div class="px-4 py-5 sm:p-6">
                {% if form.non_field_errors %}
                    <div class="mb-4 p-4 bg-red-50 rounded-md">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="h-5 w-5 text-red-400 fas fa-exclamation-circle"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">
                                    Des erreurs sont survenues lors de la soumission du formulaire
                                </h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <ul class="list-disc pl-5 space-y-1">
                                        {% for error in form.non_field_errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <div class="space-y-6">
                    <!-- Basic Information -->
                    <div>
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Informations de base</h3>
                        <p class="mt-1 text-sm text-gray-500">Informations générales sur le modèle.</p>
                    </div>

                    <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                        <!-- Brand -->
                        <div class="sm:col-span-3">
                            <label for="{{ form.brand.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                Marque <span class="text-red-500">*</span>
                            </label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-tag text-gray-400"></i>
                                </div>
                                {{ form.brand }}
                                {% if form.brand.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.brand.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Name -->
                        <div class="sm:col-span-3">
                            <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                Nom du modèle <span class="text-red-500">*</span>
                            </label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-tag text-gray-400"></i>
                                </div>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.name.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="sm:col-span-6">
                            <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                Description
                            </label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Image Upload -->
                        <div class="sm:col-span-6">
                            <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                Image du modèle
                            </label>
                            <div class="mt-1 flex items-center">
                                <div x-data="{ imagePreview: '{% if form.instance.image %}{{ form.instance.image.url }}{% else %}{% static 'img/placeholder.png' %}{% endif %}' }" class="flex-1">
                                    <!-- Hidden file input -->
                                    <input type="file" 
                                    x-ref="fileInput"
                                    id="{{ form.image.id_for_label }}" 
                                    name="{{ form.image.name }}" 
                                    class="hidden" 
                                    @change="fileChaged"
                                    accept="image/*">
                                    <!-- Image preview and upload area -->
                                    <div class="mt-2 flex items-center">
                                        <div class="flex-shrink-0 h-32 w-32 overflow-hidden rounded-md border border-gray-200">
                                            <img x-bind:src="imagePreview" 
                                                 alt="Aperçu de l'image" 
                                                 class="h-full w-full object-cover"
                                                 id="image-preview">
                                        </div>
                                        <div class="ml-4">
                                            <button type="button" 
                                            @click="$refs.fileInput.click()"
                                            class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                        <i class="fas fa-upload mr-2"></i>
                                        Choisir une image
                                    </button>
                                            <p class="mt-2 text-xs text-gray-500">
                                                PNG, JPG, JPEG jusqu'à 5MB
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Error message -->
                                    {% if form.image.errors %}
                                        <p class="mt-2 text-sm text-red-600">{{ form.image.errors.0 }}</p>
                                    {% endif %}
                                    
                                    <!-- Clear checkbox if image exists -->
                                    {% if form.instance.image %}
                                    <div class="mt-2 flex items-center">
                                        <input type="checkbox" 
                                               id="{{ form.image.name }}-clear_id" 
                                               name="{{ form.image.name }}-clear" 
                                               class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                        <label for="{{ form.image.name }}-clear_id" class="ml-2 block text-sm text-gray-700">
                                            Supprimer l'image actuelle
                                        </label>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Specifications -->
                        <div class="sm:col-span-6">
                            <label for="{{ form.specifications.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                Spécifications techniques (JSON)
                            </label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">
                                        <i class="fas fa-code text-gray-400"></i>
                                    </span>
                                </div>
                                {{ form.specifications }}
                                {% if form.specifications.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.specifications.errors.0 }}</p>
                                {% else %}
                                    <p class="mt-1 text-xs text-gray-500">
                                        Format JSON attendu. Exemple: {"couleur": "rouge", "poids": "10kg", "dimensions": "10x20x30cm"}
                                    </p>
                                {% endif %}
                            </div>
                            <style>
                                #{{ form.specifications.id_for_label }} {
                                    @apply block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm;
                                    min-height: 100px;
                                    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
                                    font-size: 0.875rem;
                                    line-height: 1.5;
                                }
                            </style>
                        </div>

                        <!-- Status -->
                        <div class="sm:col-span-6">
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    {{ form.is_active }}
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="{{ form.is_active.id_for_label }}" class="font-medium text-gray-700">
                                        Modèle actif
                                    </label>
                                    <p class="text-gray-500">Décochez pour désactiver ce modèle sans le supprimer.</p>
                                </div>
                            </div>
                            {% if form.is_active.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.is_active.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="px-4 py-3 bg-gray-50 text-right sm:px-6 rounded-b-lg">
                <div class="flex justify-end space-x-3">
                    <a href="{% if form.instance.pk %}{% url 'products:productmodel-detail' form.instance.slug %}{% else %}{% url 'products:productmodel-list' %}{% endif %}" 
                       class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Annuler
                    </a>
                    <button type="submit" 
                            class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        {% if form.instance.pk %}Mettre à jour{% else %}Créer{% endif %}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Add Alpine.js for dynamic form interactions -->
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('imageUpload', () => ({
            imagePreview: '{% if form.instance.image %}{{ form.instance.image.url }}{% else %}{% static 'img/placeholder.png' %}{% endif %}',
            
            fileChaged(event) {
                const file = event.target.files[0];
                if (file) {
                    // Check file size (5MB max)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Le fichier est trop volumineux. La taille maximale autorisée est de 5MB.');
                        return;
                    }
                    
                    // Check file type
                    const fileType = file.type.split('/')[0];
                    if (fileType !== 'image') {
                        alert('Veuillez sélectionner un fichier image valide.');
                        return;
                    }
                    
                    // Create preview
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.imagePreview = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },
            
            clearImage() {
                this.imagePreview = '{% static 'img/placeholder.png' %}';
                document.getElementById('{{ form.image.id_for_label }}').value = '';
            }
        }));
    });
</script>
{% endblock %}