{% extends 'admin/base_site.html' %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/forms.css' %}">
<style>
    .order-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    .order-section {
        background: #fff;
        border: 1px solid #eaeaea;
        border-radius: 4px;
        padding: 15px;
    }
    .order-section h2 {
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #eaeaea;
        font-size: 16px;
        color: #666;
    }
    .order-items {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
    }
    .order-items th, .order-items td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #eaeaea;
    }
    .order-items th {
        background: #f8f8f8;
    }
    .status-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-processing { background: #dbeafe; color: #1e40af; }
    .status-shipped { background: #d1fae5; color: #065f46; }
    .status-delivered { background: #dcfce7; color: #166534; }
    .status-cancelled { background: #fee2e2; color: #991b1b; }
    .status-paid { background: #dcfce7; color: #166534; }
    .status-pending-payment { background: #fef3c7; color: #92400e; }
    .status-failed { background: #fee2e2; color: #991b1b; }
    .status-refunded { background: #e0f2fe; color: #075985; }
    .timeline {
        position: relative;
        padding-left: 20px;
        border-left: 2px solid #e0e0e0;
        margin: 20px 0;
    }
    .timeline-item {
        position: relative;
        padding-bottom: 20px;
    }
    .timeline-item:last-child {
        padding-bottom: 0;
    }
    .timeline-item:before {
        content: '';
        position: absolute;
        left: -25px;
        top: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #4f46e5;
    }
    .timeline-date {
        font-size: 12px;
        color: #666;
    }
    .timeline-content {
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="order-details">
    <div class="order-section">
        <h2>Détails de la commande</h2>
        <p><strong>N° Commande:</strong> {{ order.order_number }}</p>
        <p><strong>Date:</strong> {{ order.created_at|date:"d/m/Y H:i" }}</p>
        <p>
            <strong>Statut:</strong>
            <span class="status-badge status-{{ order.status }}">
                {{ order.get_status_display }}
            </span>
        </p>
        <p>
            <strong>Paiement:</strong>
            <span class="status-badge status-{{ order.payment_status }}">
                {{ order.get_payment_status_display }}
            </span>
        </p>
        {% if order.paid_at %}
        <p><strong>Payé le:</strong> {{ order.paid_at|date:"d/m/Y H:i" }}</p>
        {% endif %}
        <p><strong>Total:</strong> {{ order.get_total_cost|floatformat:2 }} €</p>
        
        <h3>Articles commandés</h3>
        <table class="order-items">
            <thead>
                <tr>
                    <th>Produit</th>
                    <th>Prix</th>
                    <th>Qté</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for item in order.items.all %}
                <tr>
                    <td>
                        {% if item.product %}
                        <a href="{% url 'admin:products_product_change' item.product.id %}">
                            {{ item.product.name }}
                        </a>
                        {% else %}
                        {{ item.product_name }}
                        {% endif %}
                    </td>
                    <td>{{ item.price|floatformat:2 }} €</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.get_cost|floatformat:2 }} €</td>
                </tr>
                {% endfor %}
                <tr>
                    <td colspan="3" style="text-align: right;">Sous-total:</td>
                    <td>{{ order.total_amount|floatformat:2 }} €</td>
                </tr>
                <tr>
                    <td colspan="3" style="text-align: right;">Frais de livraison:</td>
                    <td>{{ order.shipping_cost|floatformat:2 }} €</td>
                </tr>
                <tr>
                    <td colspan="3" style="text-align: right;">TVA (20%):</td>
                    <td>{{ order.tax_amount|floatformat:2 }} €</td>
                </tr>
                <tr>
                    <td colspan="3" style="text-align: right; font-weight: bold;">Total:</td>
                    <td style="font-weight: bold;">{{ order.get_total_cost|floatformat:2 }} €</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="order-section">
        <h2>Adresse de livraison</h2>
        <div style="white-space: pre-line;">{{ order.shipping_address }}</div>
        
        <h2 style="margin-top: 20px;">Adresse de facturation</h2>
        <div style="white-space: pre-line;">{{ order.billing_address }}</div>
        
        {% if order.notes %}
        <h2 style="margin-top: 20px;">Notes</h2>
        <div style="white-space: pre-line;">{{ order.notes }}</div>
        {% endif %}
        
        <h2 style="margin-top: 20px;">Mettre à jour le statut</h2>
        <form method="post" action="{% url 'orders:admin_order_update_status' order.id %}" id="status-update-form">
            {% csrf_token %}
            <div class="form-row">
                <div>
                    <label for="status">Nouveau statut:</label>
                    <select name="status" id="status" style="width: 100%; margin: 5px 0 10px 0;">
                        {% for value, label in order.STATUS_CHOICES %}
                        <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="notes">Notes (optionnel):</label>
                    <textarea name="notes" id="notes" rows="3" style="width: 100%; margin: 5px 0 10px 0;"></textarea>
                </div>
                <div>
                    <button type="submit" class="button" style="background: #4f46e5; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                        Mettre à jour
                    </button>
                    <a href="{% url 'admin:orders_order_change' order.id %}" class="button" style="margin-left: 10px;">
                        Modifier la commande
                    </a>
                </div>
            </div>
        </form>
        
        <h2 style="margin-top: 30px;">Historique des statuts</h2>
        <div class="timeline">
            {% for history in status_history %}
            <div class="timeline-item">
                <div class="timeline-date">
                    {{ history.created_at|date:"d/m/Y H:i" }} par 
                    {% if history.created_by %}
                        {{ history.created_by.get_full_name|default:history.created_by.username }}
                    {% else %}
                        Système
                    {% endif %}
                </div>
                <div class="timeline-content">
                    <strong>{{ history.get_status_display }}</strong>
                    {% if history.notes %}
                    <p style="margin: 5px 0 0 0; color: #666;">{{ history.notes }}</p>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <p>Aucun historique disponible.</p>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusForm = document.getElementById('status-update-form');
    if (statusForm) {
        statusForm.addEventListener('submit', function(e) {
            if (!confirm('Êtes-vous sûr de vouloir mettre à jour le statut de cette commande ?')) {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}
